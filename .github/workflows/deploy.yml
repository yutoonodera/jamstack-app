name: Deploy to VPS (staging)

on:
  push:
    branches:
      - staging
  workflow_dispatch:  # 手動実行も可能に

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # リポジトリをチェックアウト
      - name: Checkout repository
        uses: actions/checkout@v3

      # SSH 用のセットアップ
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # rsync で VPS にファイル同期（中身だけ）
      - name: Sync files to VPS
        run: |
          rsync -avz \
            --exclude node_modules \
            --exclude .git \
            --exclude .next \
            --exclude .vscode \
            --exclude "*.log" \
            ./ ubuntu@${{ secrets.VPS_HOST }}:/home/ubuntu/staging-app/
        env:
          RSYNC_RSH: "ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no"

      - name: Deploy Docker Compose
        uses: appleboy/ssh-action@v0.1.7
        with:
            host: ${{ secrets.VPS_HOST }}
            username: ubuntu
            key: ${{ secrets.VPS_SSH_KEY }}
            script: |
              set -eux
              cd /home/ubuntu/staging-app

              echo "===== Pull latest images ====="
              docker compose --env-file <(echo "WORDPRESS_DB_PASSWORD=${{ secrets.WP_DB_PASSWORD }}") \
                             -f docker-compose.staging.yml pull

              echo "===== Build web container ====="
              docker compose -f docker-compose.staging.yml up -d --no-deps --build web

              echo "===== Install npm dependencies inside web ====="
              docker compose -f docker-compose.staging.yml exec -T web npm install

              echo "===== Rebuild and restart web ====="
              docker compose -f docker-compose.staging.yml up -d --build web

              echo "===== Deploy Complete ====="

      - name: Create .env.staging
        run: |
          echo "NEXT_PUBLIC_API_URL=${{ secrets.STAGING_API_URL }}" > .env.staging